let K=b;function a(){let t=["Dxzlwfu","zYbZAw1P","zw5Jzxm","ntqXndrTufvWDKC","v2jirxG","ywn0AxzL","Bwf4","y1Pvuhy","yxj0Axn0","tgvOCgC","B3biAxn0","ChjLzMvY","mZC5odLUCMLOuu4","DgfYz2v0","r2X4EM8","uxvLDwvt","Dg9bCNjH","DhjPz2DL","nJbRAeDyrMS","zvjnzg0","mte1mZmZmeLlyxL1ua","BMDZigzV","BgfYihnV","C29Tzq","mtC2ntG0mgPYsKz1va","ywrKu2LT","Ag5UtLG","yxv0B0XV","ic0G","rKf5DuG","DgL0Bgu","B2nR","yxv0B2XV","wePcsMO","BgvUz3rO","rMDQv2q","mLPKuMnKtG","ig1VBML0","BwfW","qxv0BY1m","ihnPBwLS","DgXwyxm","y01HBMfN","CKnHC2u","Aw5JBhvK","DeDZze0","zgvKvgLT","C3rVCff1","Bg9stNq","DhjHy2TZ","CMvXDwvZ","AgfZ","tfLTtgy","C2vSzwn0","y2XLyxi","uuDmuKu","AxPL","zNjVBq","C2zuyuy","u2vLzfrY","oti0nJm5mgjrAMn0uq","B2jQzwn0","nJa5mJfPAwTPENu","zs9SB2DN","seXzu0G","B25NCW","EvnLyxjJ","zw5HyMXL","Dwv1zu1V","B3j5","yxv0Ag9Y","Ag1wD08","B29W","CMfUzg9T","z2v0qxv0","zgL2zxjZ","y3vYCMvU","C2LTAwXH","zgvSzxrL","B3bZ","zMLUywXt","uuDNvfm","C2XPy2u","CLbjDe0","y29Yzq","AxrVCMLU","Dg9mB3DL","u2LTAwXH","B25PDg9Y","zuf1Dg9m","zc1WBgf5","DhjPBq","BMDZ","rxjYB3iG","CML0Eq","ywnRCW","BwLU","ywrKAw5N","CK9iwuS","lI9TDxnP","Axr5u2nV","zM9YrwfJ","zMLUza","yNvPBgru","qxv0B0XV","yMfLr2K","y2XLyw51","C2v0","Dgf0Dxm","DMfSDwvZ","u29Uz3nm","BM93","BML0B3jP","BwLSyxjt","zxjYB3i","CxvLDwvn","zxvLtw9U","D25nCW","C3rHCNrr","C29YDa","BM9YBwfS","z3vPBgq","uvfPzem","zZOG","D2T4sKm","CLnVBMDZ","C2vHCMnO","z2v0","Aw4Gyxv0","y2TlzxK","mty5mJu0mevyy0zttW","AxPLvhjH","BgfZDefK","zMXVB3i","ywrKzwrd","CMfJA0rL","y29VBgrV","B3vUDa","ywrK","zMLUzfnP","zMLUzgLU","mJiYB1rIvfLO","C2L6zq","ChvZAa","CMvWBgfJ"];return(a=function(){return t})()}(()=>{for(var t=b,e=a();;)try{if(171901==-parseInt(t(314))*(-parseInt(t(193))/2)+-parseInt(t(305))/3*(parseInt(t(320))/4)+-parseInt(t(322))/5+-parseInt(t(298))/6*(parseInt(t(219))/7)+parseInt(t(326))/8+-parseInt(t(287))/9+parseInt(t(217))/10)break;e.push(e.shift())}catch(t){e.push(e.shift())}})();let useMainPlayer=require("discor"+K(247)+"er").useMainPlayer,{findSimilarSongsLive,getDurationMs,isUnwantedResult}=require("./fuzz"+K(223)+"h"),Logger=require("../cor"+K(220)+"er").Logger,MIN_SONG_DURATION_MS=45e3;class AutoLoopManager{constructor(){var t=K;this[t(307)+t(261)+"ops"]=new Map,this[t(329)+"opHistory"]=new Map,this.queueMonitors=new Map,this[t(254)+t(267)+"ock"]=new Map}async[K(224)+K(261)+"op"](t){const e=K,r=e(190),i=t[e(278)].id;if(this[e(307)+"AutoLo"+e(236)][e(264)](i,{enabled:!0,guildId:i,lastAddedTime:Date[e(268)](),addedCount:0,preferences:{targetQueueSize:10,triggerThreshold:8,cooldownMs:15e3}}),!this.autoLoopHistory.has(i)){if("XJBJj"!==r)return;this["autoLo"+e(312)+e(226)][e(264)](i,[])}return this["startQ"+e(225)+"nitoring"](t),!0}async["disabl"+K(246)+"oop"](t){var e=K,t=t.guild.id;return this["active"+e(261)+"ops"].delete(t),this.addingSongsLock.delete(t),this[e(204)+e(273)+e(242)+"g"](t),!0}["isAutoLoopEnabled"](t){var e=K;return this["activeAutoLo"+e(236)][e(208)](t)}[K(275)+"ueueMo"+K(269)+"ng"](t){let e=K,a={rQrzY:function(t,e){return t===e},tlVas:e(281),gVJSU:e(256)+e(199)+"er",HLYSH:function(t,e){return t<=e}},s=t[e(278)].id,u=(this["queueM"+e(245)+"s"].has(s)&&clearInterval(this[e(272)+"onitors"].get(s)),setInterval(async()=>{var r,i,n,o=e;if(a.rQrzY(a.tlVas,a[o(198)]))try{if(this[o(307)+"AutoLoops"][o(208)](s)){let t=require(a.gVJSU).getMusicManager,e=t();e&&((r=e.player.nodes.get(s))?(i=r[o(206)].size,n=this[o(307)+"AutoLoops"].get(s),a[o(221)](i,n[o(313)+"ences"][o(319)+"rThreshold"])&&await this[o(327)+"ilarSongs"](r)):this[o(204)+o(273)+"itoring"](s))}else this[o(204)+"eueMonitoring"](s)}catch(t){Logger[o(271)]("Error "+o(285)+"o-loop"+o(194)+"oring for guild "+s+": "+t)}else u.error(o(250)+"in add"+o(244)+o(282)+" for guild "+g+": "+h)},8e3));this["queueM"+e(245)+"s"].set(s,u)}[K(204)+K(273)+"itoring"](t){var e=K;this[e(272)+e(245)+"s"].has(t)&&(clearInterval(this[e(272)+e(245)+"s"].get(t)),this.queueMonitors[e(235)](t))}async[K(327)+"ilarSo"+K(249)](s){var u=K,l={fLzIT:function(t,e){return t(e)},mpybi:u(311),KDoLR:function(t,e){return t===e},QGLRE:function(t,e){return t-e},eRMdm:function(t,e){return t<e},FAyuH:u(196)+"oop",cZUPv:"spotif"+u(223)+"h",Glxzo:u(255),JnUiI:function(t,e){return t!==e},WbHEx:"autoloop"},h=s[u(278)].id,g=this[u(307)+"AutoLo"+u(236)].get(h);if(g&&!this[u(254)+u(267)+"ock"][u(284)](h)){var f=Date.now(),t=f-g.lastAddedTime,e=g[u(313)+u(304)][u(293)+"wnMs"],d=s.tracks[u(299)],e=d<=1?Math.min(e,5e3):e;if(!(t<e)){this[u(254)+"SongsL"+u(333)][u(264)](h,!0);try{if(u(205)!==l.mpybi){let n=this[u(329)+"opHist"+u(226)].get(h)||[],o=s[u(233)+"tTrack"],a=s[u(206)][u(318)+"y"](),t=[o,...a[u(239)](0,5)].filter(Boolean);if(!l.KDoLR(t.length,0)){let i=this["select"+u(216)+"acks"](t,n);if(0!==i.length){let t=this[u(260)+u(292)+"dupeSet"](n,a,o),e=await this.findSimilarSongs(i,t);if(0===e.length){if("MqGxY"!==u(238))return;l.fLzIT(h,this.queueMonitors[u(284)](g))}var c=g.preferences[u(315)+u(317)+u(213)],L=Math.max(1,l[u(212)](c,d)),v=Math[u(253)](L,e.length,3);let r=0;for(let t=0;l[u(321)](t,v);t++)try{var y,M=e[t],w=await useMainPlayer().search(M[u(283)+"Query"],{requestedBy:{id:u(189)+"op",username:u(196)+u(229),bot:!0,displayName:l[u(331)]},searchEngine:l[u(309)]});0<w?.tracks?.length&&(l[u(316)]!==u(328)?((y=w[u(206)][u(259)](t=>{var e=getDurationMs(t);return(0===e||e>=MIN_SONG_DURATION_MS)&&!isUnwantedResult(t)})||w.tracks[0]).requestedBy&&!l.JnUiI(typeof y[u(207)+"tedBy"],u(218))||(y[u(207)+"tedBy"]={id:l[u(306)],username:"Auto-L"+u(229),bot:!0,displayName:l[u(331)]}),s.addTrack(y),n[u(300)]({title:M.title,artist:M.artist,addedAt:f,similarity:M[u(234)+"rity"]}),r++):h[u(300)](g))}catch(t){Logger[u(271)]("Error "+u(254)+u(197)+"ar son"+u(280)+t)}0<r&&(g[u(289)+u(203)+"e"]=f,g[u(291)+u(294)]+=r,this[u(329)+u(312)+u(226)].set(h,n.slice(-50)))}}}}catch(t){Logger.error(u(250)+"in add"+u(244)+"rSongs for guild "+h+": "+t)}finally{this[u(254)+u(267)+u(333)].delete(h)}}}}["buildTrackDedupeSet"](t,i,e){let n=K,o=new Set;return t.forEach(t=>{var e=b;o[e(295)](this[e(277)+e(288)+"ckKey"](t.artist,t[e(332)]))}),i[n(258)+"h"](t=>{var e,r=n;if("IuhRC"===r(279))return e=i.guild.id,this[r(307)+"AutoLoops"].delete(e),this["addingSongsL"+r(333)][r(235)](e),this["stopQu"+r(273)+r(242)+"g"](e),!0;e=t.author||"",t=t.title||"",o.add(this["normalizeTra"+r(286)](e,t))}),e&&(t=e[n(227)]||"",e=e.title||"",o[n(295)](this["normal"+n(288)+n(286)](t,e))),o}["normal"+K(288)+"ckKey"](t,e){var r=K;return(t.toLowerCase().trim()+" "+e.toLowerCase()[r(248)]())[r(301)+"e"](/[^\w\s]/g,"")}[K(210)+K(216)+K(252)](t,e){let i=K,r={tGsdM:i(209)},n=e.slice(-10),o=[],a=[];for(var s of t)if("LYmLf"!==r[i(202)]){var u=n.author||"",l=o[i(332)]||"";a.add(this[i(277)+"izeTra"+i(286)](u,l))}else{let e=s[i(227)]||"",r=s.title||"",t=n[i(325)](t=>t.artist["toLowe"+i(200)]()===e[i(243)+"rCase"]()&&t.title["toLowe"+i(200)]()===r[i(243)+i(200)]());t||s.requestedBy?.bot?a[i(300)](s):o.push(s)}return[...o,...a][i(239)](0,3)}async[K(296)+K(270)+K(222)](t,e){let o=K,a={RDmUE:function(t,e){return t*e},uvKXU:function(t,e){return t*e},baeGi:function(t,e){return t<e},sfTaF:function(t,e){return t+e},GQnqN:function(t,e){return t-e},FgjWd:function(t,e){return e<t},pNwxV:"hmVwO"},r=[],s=t.slice(0,3)[o(195)](t=>(t.author||"")[o(243)+"rCase"]());for(var i of t.slice(0,2))try{var n=await findSimilarSongsLive(i,8,e);r[o(300)](...n)}catch(t){Logger.error("Error "+o(297)+o(303)+o(324)+"ngs for "+i[o(332)]+": "+t)}var u,l,h=new Map;for(u of r)"rPItM"===o(240)?(l=this["normalizeTra"+o(286)](u.artist,u.title),e.has(l)||h[o(208)](l)&&!a[o(262)](h[o(284)](l).similarity,u[o(234)+"rity"])||h.set(l,u)):this["addingSongsL"+o(333)].delete(e);var g,f,t=Array[o(214)](h[o(266)]()),t=(t[o(258)+"h"](t=>{let e=o,r=t.artist.toLowerCase(),i=s.filter(t=>r.includes(t)||t[e(201)+"es"](r)).length,n=1;0<i&&(n-=Math.min(.6,a.RDmUE(.3,i))),t[e(232)+e(257)+"re"]=Math[e(308)](.1,n),t[e(237)+"core"]=.5*t["simila"+e(251)]+a[e(302)](t[e(232)+e(257)+"re"],.5)}),t[o(276)]((t,e)=>e[o(237)+o(241)]-t[o(237)+"core"])),d=[],c=new Map;for(g of t.slice(0,20)){var L=g[o(310)][o(243)+o(200)](),v=c.get(L)||0;if(v<2&&(d.push(g),c[o(264)](L,a[o(215)](v,1))),12<=d[o(191)])break}for(let t=a.GQnqN(d.length,1);a[o(192)](t,0);t--)o(228)!==a.pNwxV?r[o(271)](o(250)+"findin"+o(303)+o(324)+o(323)+"r "+s[o(332)]+": "+h):(f=Math[o(290)](Math[o(230)]()*(t+1)),[d[t],d[f]]=[d[f],d[t]]);return d.slice(0,6)}[K(231)+"oLoopS"+K(265)](t){let e=K,r=this["activeAutoLo"+e(236)].get(t);return r?(t=this.autoLoopHistory[e(284)](t)||[],{enabled:!0,addedCount:r[e(291)+"ount"],targetQueueSize:r.preferences.targetQueueSize,cooldownRemaining:Math[e(308)](0,r["prefer"+e(304)][e(293)+e(274)]-(Date[e(268)]()-r.lastAddedTime)),recentlyAdded:t[e(239)](-3)[e(195)](t=>t[e(310)]+e(330)+t.title)}):null}[K(263)+"p"](){var t,e=K;for([,t]of this["queueM"+e(245)+"s"])clearInterval(t);this["queueM"+e(245)+"s"][e(211)](),this[e(307)+e(261)+"ops"].clear(),this[e(329)+"opHistory"][e(211)](),this.addingSongsLock[e(211)]()}}function b(n,t){let o=a();return(b=function(t,e){t-=189;let r=o[t];void 0===b.hlwtZY&&(b.ZhJwnP=function(n){let o="",r="";for(let t=0,e,r,i=0;r=n.charAt(i++);~r&&(e=t%4?64*e+r:r,t++%4)&&(o+=String.fromCharCode(255&e>>(-2*t&6))))r="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(r);for(let t=0,e=o.length;t<e;t++)r+="%"+("00"+o.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(r)},n=arguments,b.hlwtZY=!0);var t=t+o[0],i=n[t];return i?r=i:(r=b.ZhJwnP(r),n[t]=r),r})(n,t)}module.exports=new AutoLoopManager;