let F=b,{ActionRowBuilder,EmbedBuilder,ButtonBuilder,ButtonStyle,MessageFlags}=((()=>{for(var e=b,t=a();;)try{if(309432==-parseInt(e(461))+-parseInt(e(431))/2+parseInt(e(406))/3*(-parseInt(e(543))/4)+-parseInt(e(411))/5*(-parseInt(e(538))/6)+parseInt(e(541))/7*(-parseInt(e(515))/8)+parseInt(e(548))/9+parseInt(e(506))/10)break;t.push(t.shift())}catch(e){t.push(t.shift())}})(),require("discord.js")),{getConfig,getLang}=require(F(605)+F(536)+F(518)+F(419)),{replacePlaceholders,deferIfNeeded,safeInteractionResponse}=require("./ticketUtil"+F(489)),Ticket=require("../../models/tickets"),notifyWatchers=require(F(463)+F(526)+"hers").notifyWatchers,claimLocks=new Map,LOCK_TIMEOUT=1e4;function acquireLocalLock(e){var t=F,i=Date.now(),n=claimLocks.get(e);return!(n&&{EMyRc:function(e,t){return e-t}}[t(574)](i,n[t(586)+"amp"])<LOCK_TIMEOUT||(claimLocks[t(426)](e,{timestamp:i}),0))}function releaseLocalLock(e){var t=F;claimLocks[t(503)](e)}function isValidRoleId(e){var t=F;return e&&{BPBet:function(e,t){return t<e}}[t(570)](e.length,10)&&/^\d+$/.test(e)}function a(){let e=["yxv0Ag9Y","q2XHAw0G","zcbIEsb7","nZC1mtq4qNLgqwzs","zxjYB3i","zxruAwnR","ENbHCvm","BwvTyMvY","C3rHCNrZ","B25gB3jT","zgf0zq","yw5ZD2vY","DMuGC3vJ","DgXSAfe","q3jLyxrP","C2LVBK92","te5WuuK","ywLTlG","tM90q2XH","zMLUze9U","A2v0ignS","zej5qNv0","DxnLCKLK","BcbUB3qG","z2v0","B2XVCNm","y2TLDc4","DhPhvMC","Aw1Lza","Aw0GyNv0","zgf0yq","ExbLlG","AwnRzxqU","nJeZmtG0uMzlAhLx","BgfPBwvY","lI90AwnR","CN0GAgfZ","Dg9UoG","y2XHAw1L","AM9PBG","DMXMBfm","C3nLzc4G","y2vZC2z1","sgrIv2i","BMCGy2XH","uMvZDhjP","DxnLCM5H","E3vZzxj9","y2vdBgfP","rgvZy3jP","q2XHAw1P","z3vPBgq","zMLYC3rn","y2fJAgu","CYb0AwnR","EhPNu2m","zMLSDgvY","q2XHAw1L","oMnSywLT","r0XrweO","zNjVBq","CY5QCW","ig5VDcbO","q2HHBM5L","vKzkzfC","r0rPCKO","8j+uKYb7DxnL","uMvK","BeDmwLm","CxHqCve","AxmGy3vY","AwnRzxqG","ywLTzwq","Aw4GCMvZ","ugXLyxnL","zgvSzxrL","r3vjCfa","BM90ihvU","mtq0odyZntbbC2fJDvq","Aw4GC2v0","vw5JBgfP","AxnbCNjH","BwvZC2fN","BgX5ignS","yu5kyxm","igHHCYbI","y2TLDcb0","mJmWmJyZmMPqBxzAzG","zYbJBgfP","qwXYzwfK","AwDmB2fK","DgHPCYb0","C2v0q29S","tMfTzq","ChjVy2vZ","BNrnyw5H","BwfW","oNvUy2XH","zxrxyxrJ","rKv0tuq","rhPJqvi","zLziwvy","BMCGDgLJ","ignSywLT","B2fKzxi","yMXLlG","BMCGCgvY","zYbWzxjT","zs9JB25M","C2vUza","mZy2BNDYswn5","BwvK","wxfVB0y","n1PbsMDezG","BNmGzM9Y","neHpDw5MDa","x2LK","vhLWzq","Aw9UCZO","BwLZC2LV","mtu3mdy1m3z2C0HTtG","AgDbwvy","B3iGAw5H","y2vTzw50","DxbKyxrP","zxj9","v0LkBLG","AgLZihrP","vwrRCNe","AxnZAw9U","igjLAw5N","y1fWvhK","ihjVBguG","sMPmA0W","CMvTB3zP","DgLJA2v0","DM10sKe","y2TLDc4G","vgHPCYb0","C2vSzwn0","zMLUza","CMvWBgfJ","qLbczxq","zxjTAxnZ","CxvLC3rP","AvfkCee","ru15uMm","zwqGDgHP","zxzLCNLV","ywLTzwqG","q291BgqG","rgvMyxvS","DfjVBgu","zufUzfvW","CgvYBwLZ","Dg9pyMPL","CYbMB3iG","zMv0y2G","DgLTzxn0","Aw1Lzcb0","Aw1LCIbW","uhjVy2vZ","ywrKB25m","BMCGyxv0","Dw5JBgfP","r3jLzw4","v0fMvwW","C2v0DgLU","E2nSywLT","BsbWzxjT","v2L0Aa","DxnLCG","ufjPB1a","AgfUzgXP","uxvLC3rP","vhLWzxm","u3vWCg9Y","lI4Vy29Y","qw5UB3vU","zxnZywDL","Aw5JBhvK","rxjYB3iG","suPyzwS","B24GDg8G","z2v0rxzL","CM9Szxm","Dg9tDhjP","ihvUy2XH","zxj3CML0","AxmGywXY","C2v0rgvZ","ENfUBLm","lsb0AwnR","z2vY","sunNChG","rw1Izwrd","yMvKoG","ywXS","vgLJA2v0","y2f0y2G","BujjANO","mZiWmJuZvK9YAfL6","C2LUzW","Aw5NigLZ","zej5","DguGy2HH","nJy5mePYA2votq","zw1PDfnH","igj5ihTJ","qurcDxi","y3jPChrP","rw5HyMXL","y2HHBM5L","q2XHAw0","zxiUANm","B3iGB2nJ","zwrPDa","ig5VDcbL","D2HPBguG","zwfKEsbJ","y2XHAw0G","C2v0","z2fPBI4"];return(a=function(){return e})()}async function handleTicketClaim(n,a,r){let s=F,o={CqaPz:function(e){return e()},IzoZH:function(e,t,i){return e(t,i)},Hgllp:function(e,t,i){return e(t,i)},ICgpx:function(e,t){return e===t},WIJnX:"TgGQq",PuPMB:"vmtJA",aNJas:function(e,t){return e===t},ADBur:s(578)+s(505)+"claim "+s(397)+"et sta"+s(410)+"nged.",vaWvh:s(403)+s(513)+"een un"+s(466)+"d.",tzGVg:s(592)+s(539),zKlzx:s(494)+s(464)+s(615)+s(587)+"his ti"+s(454),HdbWb:function(e,t,i){return e(t,i)},myqKf:s(596)+s(553),KWWpy:s(528),zOipu:"wJImr",Udkrq:function(e,t,i,n,a){return e(t,i,n,a)},pcJsd:s(563)+s(486)+"ed",xzgSc:function(e,t,i,n,a){return e(t,i,n,a)},DMXIN:function(e,t){return e!==t},FEtMD:s(540),vBsHx:function(e,t,i,n){return e(t,i,n)},KaEYg:function(e,t){return e(t)}},c=o.CqaPz(getConfig),l=getLang(),e=!1;try{if(await deferIfNeeded(a),e=acquireLocalLock(r)){var u=await Ticket.findOne({ticketId:r});if(u){var d=a[s(417)+"l"];if(d){var m,g,f,w,y,v=c["Ticket"+s(603)][u[s(563)+"Type"]];if(v&&v[s(478)+"ng"]&&v[s(478)+"ng"][s(416)+"d"]){let e=(v[s(604)+s(580)]||[]).filter(isValidRoleId),t=a[s(435)][s(613)].cache[s(524)](e=>e.id),i=0<e.length&&e.some(e=>t[s(608)+"es"](e));if(!i)return!o[s(399)](o[s(554)],"bpoOW")&&void await safeInteractionResponse(a,"You do"+s(490)+"ave permissi"+s(611)+s(425)+"tickets.");if(u[s(466)+"d"]){if(o.PuPMB!==s(564))return!1;o[s(512)](u[s(466)+"dBy"],a[s(599)].id)?(m=await Ticket[s(447)+s(581)+s(438)]({ticketId:r,claimed:!0,claimedBy:a[s(599)].id},{claimed:!1,claimedBy:null},{new:!0}))?(await resetTicketPermissions(d,u,v),(g=await d[s(510)+"es"][s(585)](u[s(480)+"essageId"]).catch(()=>null))&&await Promise[s(402)]([updateClaimButton(g,v,null),updateTicketEmbed(g,u,v,null)]),f=(new EmbedBuilder)["setDes"+s(415)+"on"](l?.Tickets?.[s(418)]?.["Unclai"+s(539)]||o.vaWvh)[s(520)+"or"](c[s(400)+s(453)]),global[s(590)+s(532)]&&global[s(590)+s(532)][s(612)+s(523)+s(398)]()[s(412)+"fe"]("ticket"+s(525)+s(456),{ticket:m[s(583)+"ct"](),previousClaimer:a[s(599)],guild:a.guild,channel:d}),notifyWatchers(n,m.toObject(),o[s(455)],{unclaimerId:a[s(599)].id,excludeUser:a[s(599)].id}),await safeInteractionResponse(a,{embeds:[f]}),v.Claiming.AnnounceClaim&&(w=(new EmbedBuilder)[s(520)+"or"](s(495))[s(395)+"cription"]((l?.[s(403)+"s"]?.Claim?.Announcements?.[s(508)+s(539)]||o.zKlzx).replace("{user}",a[s(599)].toString())),await d[s(537)]({embeds:[w]}))):await safeInteractionResponse(a,o[s(414)]):(y=await Ticket.findOne({ticketId:r}).select(s(466)+"dBy").lean(),await o[s(471)](safeInteractionResponse,a,(l?.Tickets?.[s(418)]?.[s(517)+"yClaimed"]||s(566)+s(499)+s(617)+s(424)+"laimed"+s(413)+"laimer}.")[s(569)+"e"](o.myqKf,"<@"+(y?.[s(466)+s(409)]||u.claimedBy)+">")))}else{var C,h=await Ticket["findOn"+s(581)+s(438)]({ticketId:r,claimed:!1},{claimed:!0,claimedBy:a.user.id},{new:!0});if(h){await setClaimPermissions(d,u,v,a[s(599)].id);var L=await d[s(510)+"es"][s(585)](u[s(480)+s(607)+"Id"]).catch(()=>null);if(L){if(o.KWWpy===o.zOipu)return!1;await Promise.all([updateClaimButton(L,v,a.user),o[s(556)](updateTicketEmbed,L,u,v,a.user)])}var p,B=(new EmbedBuilder).setDescription(l?.[s(403)+"s"]?.Claim?.Success||"You ha"+s(440)+s(470)+s(511)+s(577)+s(519)+s(460)).setColor(c[s(400)+"olors"]);global[s(590)+s(532)]&&global["addonL"+s(532)]["getEve"+s(523)+"ger"]()[s(412)+"fe"](o.pcJsd,{ticket:h[s(583)+"ct"](),claimer:a.user,guild:a.guild,channel:d}),o[s(483)](notifyWatchers,n,h[s(583)+"ct"](),s(466)+"d",{claimerId:a.user.id,excludeUser:a[s(599)].id}),await safeInteractionResponse(a,{embeds:[B]}),v[s(478)+"ng"][s(606)+"ceClaim"]&&(p=(new EmbedBuilder)[s(520)+"or"]("Green").setDescription((l?.Tickets?.[s(418)]?.[s(606)+s(551)+"s"]?.Claimed||"ðŸŽ« {user} has"+s(531)+s(575)+s(482)+"et.")[s(569)+"e"](s(475),a.user.toString())),await d[s(537)]({embeds:[p]}))}else(C=await Ticket.findOne({ticketId:r})[s(567)](s(466)+"dBy cl"+s(500)).lean())?.claimed?await safeInteractionResponse(a,(l?.Tickets?.[s(418)]?.AlreadyClaimed||s(566)+"icket "+s(617)+"eady claimed by {c"+s(462)+"}.").replace("{claim"+s(553),"<@"+C[s(466)+s(409)]+">")):await safeInteractionResponse(a,s(578)+"not claim ti"+s(565)+s(502)+" try a"+s(427))}}else await o.IzoZH(safeInteractionResponse,a,l?.Tickets?.[s(418)]?.[s(446)+"imable"]||"Ticket"+s(531)+s(408)+s(422)+"nabled for t"+s(555)+s(514)+s(459))}else await safeInteractionResponse(a,s(491)+s(451)+"found "+s(550)+"ccessi"+s(533))}else await o.Hgllp(safeInteractionResponse,a,s(403)+" not found.")}else await o.IzoZH(safeInteractionResponse,a,l?.[s(403)+"s"]?.[s(418)]?.[s(589)+s(407)]||s(566)+s(499)+s(498)+"rently"+s(558)+" proce"+s(469)+s(502)+" wait.")}catch(e){o.DMXIN("YqooF",o[s(527)])?r.error(s(609)+"updating ticket em"+s(401),o):(console[s(432)]("Error "+s(601)+s(530)+s(448)+"aim:",e),await o.vBsHx(safeInteractionResponse,a,"An err"+s(420)+"urred "+s(423)+s(522)+"sing the ticket cl"+s(445),!0))}finally{e&&o.KaEYg(releaseLocalLock,r)}}async function updateClaimButton(e,t,i){let n=F,a={JjLkL:function(e){return e()},NMvYi:n(504),zqnnS:"{claimer}",eEFMe:n(609)+n(552)+n(472)+"im button:"},r=a[n(561)](getLang);try{var s,o;"GuIpP"!==a.NMvYi?a.error("Error "+n(552)+n(534)+"missio"+n(542)+" role "+r+":",h):e.components?.[0]&&(o=(s=ActionRowBuilder[n(488)](e.components[0])).components[n(568)](e=>e[n(458)]?.["custom"+n(544)]?.[n(436)+n(598)]("ticketclaim")))&&(o.setLabel(i?(r?.[n(403)+"s"]?.Claim?.[n(485)+n(449)+"ton"]||n(485)+n(430)+n(466)+"r}").replace(a[n(396)],i[n(474)+"me"]):t[n(478)+"ng"].Button[n(521)]||n(429)+"Ticket"),await e[n(421)]({components:[s]}).catch(()=>{}))}catch(e){if("JrTcS"===n(434))return!1;console[n(432)](a.eEFMe,e)}}function b(r,e){let s=a();return(b=function(e,t){e-=395;let i=s[e];void 0===b.xobAPL&&(b.PHOOpo=function(a){let r="",i="";for(let e=0,t,i,n=0;i=a.charAt(n++);~i&&(t=e%4?64*t+i:i,e++%4)&&(r+=String.fromCharCode(255&t>>(-2*e&6))))i="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(i);for(let e=0,t=r.length;e<t;e++)i+="%"+("00"+r.charCodeAt(e).toString(16)).slice(-2);return decodeURIComponent(i)},r=arguments,b.xobAPL=!0);var e=e+s[0],n=r[e];return n?i=n:(i=b.PHOOpo(i),r[e]=i),i})(r,e)}async function updateTicketEmbed(n,a,r,s){let o=F,c={PGnSm:function(e){return e()},tllhQ:function(e,t){return t<e}},l=c.PGnSm(getConfig);try{if(n.embeds?.[0]){let e=EmbedBuilder[o(488)](n.embeds[0]),i=l[o(403)+o(442)+"on"][a[o(563)+o(545)]]||l[o(403)+o(442)+"on"][o(579)+"t"],t="";a[o(572)+"ons"]&&c[o(441)](a.questions.length,0)&&(o(468)!==o(468)?r(s):t=a.questions.map(t=>i["Questi"+o(437)+"at"][o(524)](e=>replacePlaceholders(e,{question:t[o(572)+"on"],answer:t.answer})).join("\n")).join("\n\n"));var u=i.Embed[o(477)+"ption"][o(524)](e=>replacePlaceholders(e,{ticketType:r.Name,user:"<@"+a.userId+">",guild:n.guild.name,questions:t,claimer:s?"<@"+s.id+">":o(508)+"med"})).join("\n");e[o(395)+"cription"](u),await n[o(421)]({embeds:[e]}).catch(()=>{})}}catch(e){console.error("Error "+o(552)+"ng ticket embed:",e)}}async function setClaimPermissions(t,n,e,a){var r=F,s={cZSZd:function(e,t){return e(t)},PAWZh:r(444),hgAYV:function(e,t){return e||t},PRioP:function(e,t){return e===t}};try{if(await t[r(582)+r(443)+"erwrites"].edit(t[r(479)].roles[r(576)+"ne"],{ViewChannel:!1,SendMessages:!1,ReadMessageHistory:!1}),n[r(450)])try{if(r(497)!==r(405)){let e=await t.guild[r(435)+"s"][r(585)](n.userId).catch(()=>null);e&&await t["permissionOv"+r(616)+"es"][r(421)](n.userId,{ViewChannel:!0,SendMessages:!0,ReadMessageHistory:!0,AttachFiles:!0,EmbedLinks:!0})}else e.error("Error "+r(552)+r(472)+r(457)+r(465),a)}catch(e){console.error("Error "+r(595)+r(535)+"issions for user "+n.userId+":",e)}if(a)try{let e=await t.guild[r(435)+"s"][r(585)](a).catch(()=>null);e&&await t["permissionOv"+r(616)+"es"][r(421)](a,{ViewChannel:!0,SendMessages:!0,ReadMessageHistory:!0,AttachFiles:!0,EmbedLinks:!0})}catch(e){console[r(432)]("Error setting permission"+r(584)+"claimer "+a+":",e)}if(e.SupportRole&&Array.isArray(e[r(604)+r(580)])){var o,c=e[r(478)+"ng"]&&e.Claiming.RestrictResponse,u=e.Claiming&&e[r(478)+"ng"][r(473)+"ctView"];for(o of e["Suppor"+r(580)])if(s.cZSZd(isValidRoleId,o)){var d=t.guild.roles.cache.get(o);if(d)try{if(s.PAWZh===r(529))return!1;await t["permissionOv"+r(616)+"es"][r(421)](d,{ViewChannel:!u,SendMessages:!u&&!c,ReadMessageHistory:!u,AttachFiles:!s[r(549)](u,c),EmbedLinks:!u&&!c})}catch(e){s[r(600)](r(487),r(493))?h[r(590)+r(532)].getEventManager()[r(412)+"fe"]("ticket"+r(486)+"ed",{ticket:i.toObject(),claimer:j[r(428)],guild:k.guild,channel:l,autoClaimed:!0}):console.error("Error updating per"+r(547)+r(542)+r(560)+o+":",e)}}}}catch(e){throw console[r(432)](r(609)+r(507)+"ClaimPermiss"+r(546),e),e}}async function resetTicketPermissions(e,t,i){let n=F,a={iQJpA:"znHgB",snSgn:"Error "+n(501)+n(433)+"etPermissions:"};try{if(t[n(466)+n(409)])try{await e[n(582)+n(443)+n(616)+"es"][n(503)](t["claime"+n(409)])}catch(e){console[n(432)](n(609)+n(562)+n(472)+n(588)+n(571)+"ions:",e)}if(await e[n(582)+"sionOv"+n(616)+"es"].edit(e.guild.roles.everyone,{ViewChannel:!1,SendMessages:!1,ReadMessageHistory:!1}),t[n(450)])if("aDXRe"===a[n(573)])g=h.questions.map(t=>k[n(602)+n(437)+"at"][n(524)](e=>t(e,{question:t.question,answer:t[n(439)]})).join("\n"))[n(467)]("\n\n");else try{await e[n(479)].members.fetch(t.userId).catch(()=>null)&&await e[n(582)+n(443)+"erwrites"].edit(t[n(450)],{ViewChannel:!0,SendMessages:!0,ReadMessageHistory:!0,AttachFiles:!0,EmbedLinks:!0})}catch(e){console[n(432)](n(609)+"setting perm"+n(557)+n(584)+"user "+t[n(450)]+":",e)}if(i["Suppor"+n(580)]&&Array[n(509)+"y"](i[n(604)+"tRole"]))for(var r of i[n(604)+"tRole"]){var s;isValidRoleId(r)&&(s=e.guild.roles[n(481)][n(452)](r))&&await e.permissionOverwrites.edit(s,{ViewChannel:!0,SendMessages:!0,ReadMessageHistory:!0,AttachFiles:!0,EmbedLinks:!0})}}catch(e){throw console[n(432)](a.snSgn,e),e}}async function handleAutoClaim(a,r,s){let o=F,c={wJqOF:function(e,t){return e===t},ThyQX:function(e,t){return e!==t},IJXek:function(e,t,i,n,a){return e(t,i,n,a)},fMrgt:function(e,t,i,n,a){return e(t,i,n,a)},BajJP:o(593),WAfUl:function(e,t){return e(t)}},l=getConfig(),u=getLang(),d=!1;try{let i=l["Ticket"+o(603)][s.ticketType];if(!i){if(c.wJqOF("VFJdW",o(492)))return!1;s[o(432)]("Error "+o(562)+"ng cla"+o(588)+"ermiss"+o(546),c)}if(!i.Claiming?.Enabled||!i[o(478)+"ng"]?.AutoClaim){if(!c.ThyQX(o(496),o(496)))return!1;u["addonL"+o(532)][o(612)+"ntManager"]()[o(412)+"fe"](o(563)+o(486)+"ed",{ticket:d.toObject(),claimer:i[o(599)],guild:e.guild,channel:t})}if(s.claimed)return!1;if(s.userId===r.author.id)return!1;let e=(i.SupportRole||[])[o(484)](isValidRoleId);if(0===e.length)return!1;let t=r[o(435)].roles.cache[o(524)](e=>e.id),n=e.some(e=>t[o(608)+"es"](e));var m,g,f,w;return n?!!(d=acquireLocalLock(s[o(563)+"Id"]))&&!!(m=await Ticket["findOn"+o(581)+o(438)]({ticketId:s[o(563)+"Id"],claimed:!1},{claimed:!0,claimedBy:r.author.id},{new:!0}))&&(g=r.channel,c[o(610)](setClaimPermissions,g,s,i,r[o(428)].id)[o(404)](e=>{var t=o;"cQpTy"===t(559)?console[t(432)]("Error "+t(595)+t(516)+t(597)+t(557)+"s:",e):(e=(new l)[t(520)+"or"]("Green")[t(395)+"cription"]((u?.Tickets?.[t(418)]?.["Announ"+t(551)+"s"]?.Claimed||"ðŸŽ« {user} has claimed thi"+t(482)+"et.")[t(569)+"e"]("{user}",d.author.toString())),i.send({embeds:[e]})[t(404)](()=>{}))}),(f=await g.messages.fetch(s.firstMessageId).catch(()=>null))&&Promise.all([updateClaimButton(f,i,r.author),updateTicketEmbed(f,s,i,r.author)]).catch(()=>{}),global.addonLoader&&global["addonL"+o(532)]["getEventMana"+o(398)]().emitSafe("ticket"+o(486)+"ed",{ticket:m[o(583)+"ct"](),claimer:r.author,guild:r.guild,channel:g,autoClaimed:!0}),c.fMrgt(notifyWatchers,a,m.toObject(),"claimed",{claimerId:r[o(428)].id,excludeUser:r.author.id}),i.Claiming["Announ"+o(476)+"m"]&&(w=(new EmbedBuilder).setColor(c.BajJP)["setDes"+o(415)+"on"]((u?.[o(403)+"s"]?.[o(418)]?.Announcements?.[o(485)+"d"]||"ðŸŽ« {use"+o(464)+" claimed thi"+o(482)+"et.")[o(569)+"e"]("{user}",r.author[o(614)+"ng"]())),g[o(537)]({embeds:[w]})[o(404)](()=>{})),!0):!1}catch(e){return console[o(432)](o(609)+o(601)+o(591)+"o claim:",e),!1}finally{d&&c[o(594)](releaseLocalLock,s.ticketId)}}module.exports={handleTicketClaim:handleTicketClaim,handleAutoClaim:handleAutoClaim,updateClaimButton:updateClaimButton,updateTicketEmbed:updateTicketEmbed,setClaimPermissions:setClaimPermissions,resetTicketPermissions:resetTicketPermissions};